# Sobol 采样器架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PBRenderer 架构                               │
└─────────────────────────────────────────────────────────────────────┘

                            ┌──────────────┐
                            │   Sampler    │  (基类接口)
                            │  (新增)      │
                            └──────┬───────┘
                                   │
                    ┌──────────────┴──────────────┐
                    │                             │
             ┌──────▼──────┐              ┌──────▼──────┐
             │ SobolSampler│              │ RNGSampler  │
             │  (推荐)     │              │  (兼容)     │
             └──────┬──────┘              └──────┬──────┘
                    │                             │
                    └──────────────┬──────────────┘
                                   │
                    ┌──────────────▼──────────────┐
                    │                             │
                    │      渲染器层 (使用者)      │
                    │                             │
                    └──────────────┬──────────────┘
                                   │
        ┌──────────────────────────┼──────────────────────────┐
        │                          │                          │
   ┌────▼─────┐              ┌────▼─────┐              ┌────▼─────┐
   │PTRenderer│              │MISRenderer│             │其他渲染器 │
   │(路径追踪)│              │(MIS集成) │             │          │
   └────┬─────┘              └────┬─────┘              └────┬─────┘
        │                         │                         │
        └─────────────────────────┼─────────────────────────┘
                                  │
        ┌─────────────────────────┼─────────────────────────┐
        │                         │                         │
        │         需要采样的组件 (被采样者)                 │
        │                                                   │
        │  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
        │  │  Camera  │  │ Material │  │  Light   │      │
        │  │          │  │          │  │          │      │
        │  │ 光线采样  │  │ BSDF采样 │  │ 光源采样  │      │
        │  └────┬─────┘  └────┬─────┘  └────┬─────┘      │
        │       │             │             │             │
        │       │      ┌──────┴──────┐      │             │
        │       │      │ Microfacet  │      │             │
        │       │      │  法线采样    │      │             │
        │       │      └─────────────┘      │             │
        │       │                           │             │
        │       └───────────────────────────┴─────────────┘
        │                         │                        │
        │                  ┌──────▼──────┐                │
        │                  │    Shape    │                │
        │                  │  表面采样    │                │
        │                  └─────────────┘                │
        └───────────────────────────────────────────────────┘
```

## 数据流向图

```
像素坐标 (x, y, sample_idx)
         │
         ▼
    ┌─────────────────┐
    │ SobolSampler    │
    │ StartPixelSample│  ← 初始化采样器
    └────────┬────────┘
             │
             ├─→ Get2D() ──→ Camera.GenerateRay()    (维度 0-1)
             │
             ├─→ Get1D() ──→ RussianRoulette()       (维度 2)
             │
             ├─→ Get1D() ──→ LightSampler.Sample()   (维度 3)
             │
             ├─→ Get2D() ──→ Light.SampleLight()     (维度 4-5)
             │                 │
             │                 └─→ Shape.SampleShape()
             │
             ├─→ Get2D() ──→ Material.SampleBSDF()   (维度 6-7)
             │                 │
             │                 └─→ Microfacet.SampleVisibleNormal()
             │
             ├─→ Get1D() ──→ RussianRoulette()       (维度 8)
             │
             └─→ ... (后续反弹，维度递增)
```

## 当前状态 vs 目标状态

### 当前状态（使用 RNG）

```
PTRenderer::RenderPixel()
   │
   ├─ RNG rng;  ← 伪随机
   ├─ rng.SetSeed(seed);
   │
   ├─ GenerateRay(rng.Uniform(), rng.Uniform())  ← 聚类采样
   ├─ if (rng.Uniform() > q) break;               ← 相关性
   ├─ SampleLight(rng)                            ← 质量不均
   └─ SampleBSDF(rng)                             ← 噪声多

结果：收敛慢，噪点多
```

### 目标状态（使用 Sobol）

```
PTRenderer::RenderPixel()
   │
   ├─ SobolSampler sampler;  ← 低差异序列
   ├─ sampler.StartPixelSample(pixel, idx);
   │
   ├─ GenerateRay(sampler.Get2D())      ← 均匀分层
   ├─ if (sampler.Get1D() > q) break;    ← 独立维度
   ├─ SampleLight(sampler)               ← 质量均匀
   └─ SampleBSDF(sampler)                ← 噪声少

结果：收敛快 2-3x，噪点少
```

## 修改优先级图

```
┌─────────────────────────────────────────────────┐
│ 优先级 1: 核心渲染器 ⭐⭐⭐                      │
│ ┌─────────────────────────────────────────────┐ │
│ │ PTRenderer.cpp                              │ │
│ │ MISRenderer.cpp                             │ │
│ │                                             │ │
│ │ 影响：直接提升渲染质量                       │ │
│ │ 难度：简单（替换 RNG 调用）                 │ │
│ │ 时间：1-2 小时                              │ │
│ └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
            ↓
┌─────────────────────────────────────────────────┐
│ 优先级 2: 材质系统 ⭐⭐                          │
│ ┌─────────────────────────────────────────────┐ │
│ │ material.hpp         (接口)                 │ │
│ │ diffuseMaterial.cpp  (漫反射)              │ │
│ │ conductorMaterial.cpp (导体)               │ │
│ │ dielectricMaterial.cpp (介质)              │ │
│ │ iridescentMaterial.cpp (虹彩)              │ │
│ │ microfacet.cpp       (微表面)              │ │
│ │                                             │ │
│ │ 影响：提升 BSDF 采样质量                    │ │
│ │ 难度：中等（需要理解采样逻辑）              │ │
│ │ 时间：2-3 小时                              │ │
│ └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
            ↓
┌─────────────────────────────────────────────────┐
│ 优先级 3: 光源系统 ⭐                            │
│ ┌─────────────────────────────────────────────┐ │
│ │ light.hpp           (接口)                  │ │
│ │ areaLight.cpp       (面光源)               │ │
│ │ envLight.cpp        (环境光)               │ │
│ │ infiniteLight.cpp   (无限光)               │ │
│ │                                             │ │
│ │ 影响：提升光源采样质量                       │ │
│ │ 难度：中等                                  │ │
│ │ 时间：1-2 小时                              │ │
│ └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
            ↓
┌─────────────────────────────────────────────────┐
│ 优先级 4: 形状系统 ⭐                            │
│ ┌─────────────────────────────────────────────┐ │
│ │ shape.hpp           (接口)                  │ │
│ │ sphere.cpp          (球体)                 │ │
│ │ circle.cpp          (圆盘)                 │ │
│ │ triangle.cpp        (三角形)               │ │
│ │                                             │ │
│ │ 影响：提升表面采样质量                       │ │
│ │ 难度：简单                                  │ │
│ │ 时间：1 小时                                │ │
│ └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

## 渐进式迁移路径

```
阶段 0: 准备
├─ ✅ Sobol 采样器已实现
├─ ✅ 文档已完成
└─ ✅ 示例代码已提供
         │
         ▼
阶段 1: 接口扩展 (不破坏现有代码)
├─ [ ] Material::SampleBSDF(Sampler&) 重载
├─ [ ] Light::SampleLight(Sampler&) 重载
├─ [ ] Shape::SampleShape(Sampler&) 重载
└─ [ ] 默认实现调用 RNG 版本
         │
         ▼
阶段 2: 渲染器迁移 (获得初步改善)
├─ [ ] PTRenderer 使用 SobolSampler
├─ [ ] MISRenderer 使用 SobolSampler
└─ [ ] 测试基本功能
         │
         ▼  🎯 此时已有明显效果！
         │
阶段 3: 底层实现 (完全利用 Sobol)
├─ [ ] 实现所有 Material Sampler 版本
├─ [ ] 实现所有 Light Sampler 版本
├─ [ ] 实现所有 Shape Sampler 版本
└─ [ ] 移除临时适配器
         │
         ▼
阶段 4: 优化测试
├─ [ ] 性能对比测试
├─ [ ] 视觉质量测试
└─ [ ] 文档更新
         │
         ▼
完成！🎉
```

## 性能提升预期

```
SPP (每像素采样数)
 
1000 │                           ┌─ RNG (基准)
     │                       ┌───┘
 800 │                   ┌───┘
     │               ┌───┘
 600 │           ┌───┘    ┌─ Sobol (目标)
     │       ┌───┘    ┌───┘
 400 │   ┌───┘    ┌───┘
     │┌──┘    ┌───┘
 200 │    ┌───┘
     │┌───┘
   0 └─────────────────────────────────────→ 渲染质量
                                            (相同 RMSE)
     
     ▲ 相同质量下，Sobol 需要的 SPP 更少 = 时间更短
```

## 典型使用模式对比

### 模式 A: 相机采样

```cpp
// RNG 方式
float u1 = rng.Uniform();  // [0.3, ...]  ← 随机
float u2 = rng.Uniform();  // [0.8, ...]  ← 可能聚类
auto ray = camera.GenerateRay(pixel, {u1, u2});

// Sobol 方式
glm::vec2 uv = sampler.Get2D();  // (0.25, 0.75)  ← 分层
auto ray = camera.GenerateRay(pixel, uv);

结果：Sobol 的像素内采样更均匀
```

### 模式 B: 光源采样

```cpp
// RNG 方式
float light_select = rng.Uniform();     // 选择光源
float u1 = rng.Uniform();               // 光源位置
float u2 = rng.Uniform();
// 采样可能聚集在某些区域

// Sobol 方式
float light_select = sampler.Get1D();   // 维度 N
glm::vec2 uv = sampler.Get2D();         // 维度 N+1, N+2
// 采样均匀覆盖光源表面

结果：更好的光源覆盖 → 更少噪点
```

### 模式 C: BSDF 采样

```cpp
// RNG 方式 (可能生成相关的方向)
auto dir = microfacet.Sample(view, {rng.Uniform(), rng.Uniform()});

// Sobol 方式 (独立维度，互不相关)
auto dir = microfacet.Sample(view, sampler.Get2D());

结果：更好的方向分层 → 更快收敛
```

---

## 关键要点总结

1. **从哪里开始**：PTRenderer.cpp 和 MISRenderer.cpp
2. **最大收益**：相机采样和 BSDF 采样
3. **维度管理**：每个像素每个样本调用 StartPixelSample()
4. **兼容性**：使用接口重载，逐步迁移
5. **测试验证**：对比 RNG@256spp vs Sobol@128spp

需要具体某个文件的完整修改代码，请告诉我！
